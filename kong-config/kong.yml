_format_version: "3.0"
_transform: true

# SSL Certificates in docker-compose-kong.yml

# Services define the backend APIs
services:
  - name: demofortsb-service
    url: http://host.docker.internal:8080
    retries: 5
    connect_timeout: 60000
    read_timeout: 60000
    write_timeout: 60000

    # Routes define the API endpoints
    routes:
      # ===========================================
      # PUBLIC ROUTES (No Authentication Required)
      # ===========================================

      # Health check route (Public) - HTTP & HTTPS
      - name: health-route
        paths:
          - /actuator/health
        strip_path: false
        methods:
          - GET
          - POST
        protocols:
          - http
          - https

      # Auth route (Public) - HTTP & HTTPS
      - name: auth-route
        paths:
          - /api/auth
        strip_path: false
        methods:
          - GET
          - POST
        protocols:
          - http
          - https

      # Setup route (dev only)
      - name: setup-route
        paths:
          - /api/setup
        strip_path: false
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - PATCH
        protocols:
          - http
          - https
        plugins:
          - name: key-auth
            config:
              key_names:
                - apikey
                - X-API-Key

        # API docs route (Public)
      - name: api-docs-route
        paths:
          - /v3/api-docs
        strip_path: false
        methods:
          - GET
        protocols:
          - http
          - https

    # ===========================================
    # PROTECTED ROUTES (Authentication Required)
    # ===========================================

    # HTTPS-only routes for sensitive operations
      - name: customer-route-https
        paths:
          - /api/customers
        strip_path: false
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - PATCH
        protocols:
          - https    # Force HTTPS for sensitive data
        # Add API key authentication
        plugins:
          - name: jwt
            config:
              # Header name where JWT token is expected
              uri_param_names:
                - jwt
              cookie_names: []
              header_names:
                - Authorization

              # JWT Claims to be verified
              claims_to_verify:
                - exp

              # JWT Secret (Must match Spring Boot JWT secret)
              secret_is_base64: false
              key_claim_name: iss

              # Anonymous consumer for requests without JWT
#              anonymous: false

              # Run JWT validation even if consumer already authenticated
              run_on_preflight: true

      # Account routes - JWT VALIDATION REQUIRED
      - name: account-route
        paths:
          - /api/accounts
        strip_path: false
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - PATCH
        protocols:
          - https    # Force HTTPS for sensitive data

        plugins:
          - name: jwt
            config:
              header_names:
                - authorization
              claims_to_verify:
                - exp
              secret_is_base64: false
#              anonymous: false
              run_on_preflight: true

# ===========================================
# JWT CONSUMERS & CREDENTIALS
# ===========================================

consumers:
  # Consumer for JWT validation
  - username: jwt-user
    custom_id: jwt-user-001
    jwt_secrets:
      - key: demofortsb-jwt-key
    # CRITICAL: This secret MUST match your Spring Boot JWT_SECRET
        secret: "$2a$12$Rn0.OZsB.WWH0YzNrsyHAuw6.8T5yhed10EF14Q2JHCV2FI.l1EMm"
        algorithm: HS256

  - username: admin-user
    custom_id: admin-user-001
        # Keep API key credentials for setup endpoints
    keyauth_credentials:
      - key: admin-api-key-67890

# Add global plugins
plugins:
  # HTTP to HTTPS redirect
  - name: request-transformer
    config:
      add:
        headers:
          - "X-Kong-Auth: shared-secret-12345"
          - "X-Kong-Proxy: true"
          - "X-Forwarded-Prefix: /"
          - "X-Forwarded-Proto: https"

  - name: rate-limiting
    config:
      minute: 10
      hour: 100
      policy: local
      fault_tolerant: true
      hide_client_headers: false
# Test rate limiting (make 15 requests quickly)
#  for i in {1..15}; do
#  echo "Request $i:"
#  curl -i http://localhost:8000/actuator/health 2>/dev/null | grep -E "HTTP|X-RateLimit"
#  echo ""
#  done
#
  - name: cors
    config:
      origins:
        - "http://localhost:3000" # Allow for development
        - "https://localhost:3000"
        - "http://localhost:8443"
        - "http://localhost:8001"
      methods:
        - GET
        - POST
        - PUT
        - DELETE
        - PATCH
        - OPTIONS
      headers:
        - Accept
        - Authorization
        - Content-Type
        - X-Requested-With
      exposed_headers:
        - X-Auth-Token
        - X-Total-Count
      credentials: true
      max_age: 3600
  # Test cors
#  curl -i -X OPTIONS 'http://localhost:8000/actuator/health' \
#  -H 'Origin: http://localhost:3000' \
#  -H 'Access-Control-Request-Method: GET' \
#  -H 'Access-Control-Request-Headers: Authorization, Content-Type'
#  or test by:
#  curl -i 'http://localhost:8000/actuator/health' \
#  -H 'Origin: http://localhost:3000' \
#  -H 'Authorization: Bearer <your-jwt>'

  # Add Request ID
#  - name: correlation-id
#    config:
#      header_name: X-Request-Id
#      generator: uuid
#      echo_downstream: true
# Test Request ID generation
#  curl -i http://localhost:8000/api/health | grep -i "x-request-id"
#
#  # Make multiple requests - each should have unique ID
#  for i in {1..3}; do
#  echo "Request $i:"
#  curl -i http://localhost:8000/api/health 2>/dev/null | grep -i "x-request-id"
#  done


  # Add Response-transformer, protected headers
#  - name: response-transformer
#    config:
#      add:
#        headers:
#          - X-Kong-Version:3.9
#      remove:
#        headers:
#          - Server                 # Hide server software
#          - X-Powered-By          # Hide technology stack
#          - X-Application-Context # Hide Spring Boot details

