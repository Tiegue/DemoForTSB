<configuration>
    <property name="APP" value="demofortsb"/>
    <property name="ENV" value="${SPRING_PROFILES_ACTIVE:-local}"/>

    <!-- Masking converter to hide sensitive fields -->
    <conversionRule conversionWord="mask"
                    converterClass="nz.co.tsb.demofortsb.config.logging.MaskingConverter"/>

    <!-- LOCAL profile: human-readable, DEBUG logs -->
    <springProfile name="local">
        <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
            <encoder>
                <pattern>
                    %d{yyyy-MM-dd'T'HH:mm:ss.SSS} %-5level [%thread] %logger{36}
                    traceId=%X{traceId:-na} corrId=%X{correlationId:-na} requestUri=%X{requestUri:-na} businessId=%X{businessId:-na} spanId=%X{spanId:-na} - %mask{%msg}%n
                </pattern>
            </encoder>
        </appender>

        <root level="DEBUG">
            <appender-ref ref="CONSOLE"/>
        </root>
    </springProfile>

    <!-- DOCKER profile: structured JSON logs to console + ship to Seq via GELF/TCP -->
    <springProfile name="docker">
        <!-- In Docker network, the sidecar service name is usually 'seq-input-gelf' -->
        <property name="GELF_HOST" value="${SEQ_GELF_HOST:-seq-input-gelf}"/>
        <property name="GELF_PORT" value="${SEQ_GELF_PORT:-12201}"/>

        <!-- JSON to stdout for 'docker logs'; include MDC so corrId/opId appear -->
        <appender name="JSON_CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
            <encoder class="net.logstash.logback.encoder.LogstashEncoder">
                <includeMdc>true</includeMdc>
                <customFields>{"app":"${APP}","env":"${ENV}"}</customFields>
            </encoder>
        </appender>

        <!-- Seq via GELF (UDP). Switch to GelfTcpAppender if you expose TCP. -->
        <appender name="GELF" class="de.siegmar.logbackgelf.GelfUdpAppender">
            <graylogHost>${GELF_HOST}</graylogHost>
            <graylogPort>${GELF_PORT}</graylogPort>
            <connectTimeout>15000</connectTimeout>
            <socketTimeout>5000</socketTimeout>
            <encoder class="de.siegmar.logbackgelf.GelfEncoder">
                <includeMdcData>true</includeMdcData>
                <includeKeyValues>true</includeKeyValues>
                <staticFields>{"app":"${APP}","env":"${ENV}"}</staticFields>
            </encoder>
        </appender>

        <!-- Don't block app threads on network I/O -->
        <appender name="ASYNC_GELF" class="ch.qos.logback.classic.AsyncAppender">
            <appender-ref ref="GELF"/>
            <neverBlock>true</neverBlock>
        </appender>

        <root level="INFO">
            <appender-ref ref="JSON_CONSOLE"/>
            <appender-ref ref="ASYNC_GELF"/>
        </root>
    </springProfile>
</configuration>
